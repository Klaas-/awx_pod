apiVersion: v1
kind: Pod
metadata:
  labels:
    app: {{ awx_pod_label }}
  name: {{ awx_pod_name }}
spec:
  #
  # define exported volumes for permanent data
  #
  volumes:
  - name: awx-data-volume
    hostPath:
      path: {{ awx_data_volume_host_path }}
      type: Directory
  - name: db-volume
    hostPath:
      path: {{ awx_db_volume_host_path }}
      type: Directory
  - name: secret-key
    hostPath:
      path: {{ awx_secret_key_path }}
      type: File
  - name: environment
    hostPath:
      path: {{ awx_environment_path }}
      type: File
  - name: credentials
    hostPath:
      path: {{ awx_credentials_path }}
      type: File
  containers:
  #
  # postgres container
  #
  - command:
    - docker-entrypoint.sh
    - postgres
    env:
    - name: PATH
      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/postgresql/{{ awx_postgres_version }}/bin
    - name: POSTGRES_USER
      value: {{ awx_postgres_user }}
    - name: POSTGRES_DB
      value: awx
    - name: PGDATA
      value: /var/lib/postgresql/data/pgdata
    - name: POSTGRES_PASSWORD
      value: {{ awx_postgres_password }}
    image: docker.io/library/postgres:{{ awx_postgres_version }}
    name: postgres
    volumeMounts:
    - mountPath: /var/lib/postgresql/data/pgdata:z
      name: db-volume
  #
  # memcached container
  #
  - command:
    - docker-entrypoint.sh
    - memcached
    env:
    image: docker.io/library/memcached:alpine
    name: memcached
  #
  # awx-web container
  #
  - command:
    - /tini
    - --
    - /bin/sh
    - -c
    - /usr/bin/launch_awx.sh
    env:
    - name: HOSTNAME
      value: awxweb
    image: docker.io/ansible/awx_web:{{ awx_awxweb_version }}
    name: awxweb
    workingDir: /var/lib/awx
    volumeMounts:
    - mountPath: /var/lib/awx/projects:z
      name: awx-data-volume
    - mountPath: /etc/tower/SECRET_KEY
      name: secret-key
    - mountPath: /etc/tower/conf.d/environment.sh
      name: environment
    - mountPath: /etc/tower/conf.d/credentials.py
      name: credentials
    ports:
    - containerPort: 8052
      hostPort: 8052
      protocol: TCP
  #
  # awx-task container
  #
  - command:
    - /tini
    - --
    - /bin/sh
    - -c
    - /usr/bin/launch_awx_task.sh
    env:
    - name: HOSTNAME
      value: awx
    image: docker.io/ansible/awx_task:{{ awx_awxtask_version }}
    name: awxtask
    workingDir: /var/lib/awx
    volumeMounts:
    - mountPath: /var/lib/awx/projects:z
      name: awx-data-volume
    - mountPath: /etc/tower/SECRET_KEY
      name: secret-key
    - mountPath: /etc/tower/conf.d/environment.sh
      name: environment
    - mountPath: /etc/tower/conf.d/credentials.py
      name: credentials
  #
  # rabbitmq container
  #
  - command:
    - docker-entrypoint.sh
    - /bin/sh
    - -c
    - /launch.sh
    env:
    - name: PATH
      value: /opt/rabbitmq/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: RABBITMQ_DEFAULT_VHOST
      value: awx
    - name: RABBITMQ_ERLANG_COOKIE
      value: {{ awx_rabbitmq_erlang_cookie }}
    image: docker.io/ansible/awx_rabbitmq:{{ awx_rabbitmq_version }}
    name: rabbitmq
